
# Converting and Comparing Torch, ONNX, and CoreML Resnet50

The notebooks in this folder are code for, and notes about, converting a "standard" **PyTorch** **Resnet50** model to **CoreML**.  There is no direct conversion from Pytorch to CoreML, so ONNX is used as an intermediate format.  The conversion process is:

    Torch->ONNX,  ONNX->CoreML,  then CoreML->iOS using XCode

This was primarily a learning exercise, and secondarily an experiment to investigate if an off-the-shelf  *Torch Resnet50* - e.g. from the Python torchvision  distribution - would convert successfully (... The answer is: no, it does not - yet - but for now I'm assuming that the root cause is a lack of understanding on my part. ). 

In addition to demonstrating the conversion process, and model repair where necessary, these notebooks show and compare predictions generated by the original models and their converted descendants.

### Overview
Here is the general approach:
- Obtain the intial model (By downloading from web or loading from a package).
- Sanity-check the model by generating a few predictions and confirming that they are correct.
- Continue to convert,repair when necessary, and sanity check until we generate a working CoreML Model.
- Compare the prediction results of the original model(s) to those of the converted descendants.

Test images were selected randomily from a collection of dogs, cats, plants and food images that reside on my local machine

### Summary of Conversion Results

***Torch->ONNX->CoreML***: Conversion of the Torch Resnet50 model `torchvision.models.resnet50(pretrained=True)` to  ONNX was successful. The conversion of that ONNX model to CoreML failed. The *ONNX->CoreML* step created a CoreML model that raised shape-mismatch errors when run. See Notebook `20-convert-torch-to-coreml` ).

***ONNX->CoreML***: As part of investigating possible causes of the error above, I attempted to convert an off-the-shelf ONNX Resnet50 to CoreML (see Notebook: `30-convert-onnx-to-coreml`).  That conversion was successful.  One possible interpretation of such a result is that  the *Torch -> ONNX* conversion generates an ONNX model that is either not entirely correct, or not handled by the *ONNX->CoreML* conversion tools, or both.  However,  *far more likely*  is that I introduced the error thru misunderstanding some part of the conversion procedure.  I'm still looking into this.

***Torch->ONNX->CoreML*** Resolution: To get the faulty CoreML Model to work, I edited the problematic layers (using `coremltools` and `coreml_help`) and re-verified in Python.

My takeaway from this is that any signficant conversion from Torch to CoreML that I attempt will probably require some amount of CoreML "model surgery" followed by comprehensive testing.

### Summary of Comparision Results
After conversion and repair, I compared predictions from the CoreML-converted-from-Torch Resnet50 model to predictions generated by the originals, the intermediate models, and to predictions from "off-the-shelf" ONNX and CoreML Resnet50 models. (Notebook: `40-Compare-torch-onnx-coreml`).

**95% Agreement - the "Torch Family"** - The predictions generated by the original Torch model, the intermediate  ONNX model dervied from it, and the final (after repair) CoreML model - lets call these three together the *Torch Family*  - were very consistent. About 95% or more of the predictions agreed.

**95% Agreement - the "ONNX Family"** - The "Model Zoo" ONNX model its CoreML descendant - lets call these two the *"ONNX Family"* -  also generated very consistent results. Again, about 95% agreement.

Agreement between the *Torch Family* and the *ONNX Family* was about 70%. 

Agreement between the *Torch Family* and the "native" CoreML model was about xxx



### References
#### Tools and Packages

- **[Netron](https://github.com/lutzroeder/netron)** for examining models
- [torch, torchvision](https://onnx.ai)
- [onnx](https://onnx.ai) for conversion
- [onnx_coreml](https://github.com/onnx/onnx-coreml) to convert to CoreML
- [onnxruntime](https://microsoft.github.io/onnxruntime/) for verification and debugging.
- [coremltools](https://github.com/apple/coremltools) for verification and debugging and model editing
- [coreml_help](https://github.com/mcsieber/coreml_help) (minor) Python helper tools that I wrote. A convenience. Not required.
- [pred_help](https://github.com/mcsieber/coreml_help) (minor) More python helper tools. Not required.
- [XCode 10](https://developer.apple.com/xcode/) to include the model in an iOS app and load the app onto my iPhone

#### Helpful Books, Articles, Tutorials etc ...

- [**Core ML Survival Guide**](https://leanpub.com/coreml-survival-guide) by [*Matthijs Holleman*](https://github.com/hollance)  for real help with CoreML
- [How I Shipped a Neural Network on iOS with CoreML, PyTorch, and React Native](https://attardi.org/pytorch-and-coreml)
- [raywenderlich.com](https://www.raywenderlich.com) for iOS sample apps and tutorials


### Notebooks

#### 00-Intro

This notebook.

#### 20-convert-torch-t2o-t2c

Load the packaged Torch Resnet50 (`torchvision.models.resnet50(pretrained=True)`), convert to ONNX, then convert to CoreML, checking at each step that the models work.  The *ONNX->CoreML* conversion fails. Surgery is required to fix the CoreML model. Surgery is attempted, patient survives, and the CoreML model successfully validated.  A brief analysis of agreement between the models is followed by a display of images and the resulting predictions

#### 30-convert-onnx-o2c

The initial attempt at converting from ONNX->CoreML failed (See previous notebook). Is this because of a fault in the ONNX->CoreML conversion tools, or is it  because the original model started life as a Torch model? This notebook is an experiment to investigate.

The notebook converts an off-the-shelf ONNX Resnet50 to CoreML. Successfully. So it seems that something about the two-step process (Torch->ONNX, ONNX->CoreML) is encouraging bad behavior.

#### 40-compare-torch-onnx-coreml

This notebook compares the predictions of six Resnet50 Models. It loads the original, intermediate and final models created by the conversions described previously. These are named:

- torchm - Torch model from the torchvision distribution
- t2o    - An ONNX Model. The result of converting **torchm** to ONNX.
- t2c    - A CoreML Model. The result of convering the intermediate model **t2o** to CoreML.
- onnxm  - The ONNX Resnet50 model from the ONNX Model Zoo on Github
- o2c    - A CoreML Model. The result of converting **onnxm** to CoreML.
- cml    - A CoreML Model. To the five above I added the "native" CoreML Resnet50 model.

Agreements between the predictions of all models are tabulated and presented in an "Agreement Matrix". 
A selection of images and the predictions made for them by each model is shown.



```python

```
